{% extends "base.html" %}

{% block title %}DomainSpotter - Find the Perfect Domain Name{% endblock %}

{% block content %}
<div class="hero">
    <h1>Find the Perfect Domain Name</h1>
    <p class="subtitle">Get AI-powered domain name suggestions for your next project</p>
</div>

<main>
    <section id="initial-form" class="card">
        <form id="domainForm" class="domain-form">
            <div class="form-group">
                <label for="name">Project Name</label>
                <input type="text" id="name" name="name" placeholder="e.g., My Awesome App">
            </div>

            <div class="form-group">
                <label for="description">Project Description</label>
                <textarea id="description" name="description" rows="3" placeholder="Describe your project..."></textarea>
            </div>

            <button type="submit" id="submitButton" disabled>Get Domain Suggestions</button>
        </form>
    </section>

    <section id="questions" class="card" hidden>
        <div class="section-header">
            <button type="button" class="back-button" onclick="showInitialForm()">‚Üê Back</button>
            <h2>Additional Questions</h2>
        </div>
        <form id="questionsForm">
            <div id="questionsList"></div>
            <button type="submit">Get Domain Suggestions</button>
        </form>
    </section>

    <section id="results" class="card" hidden>
        <div class="section-header">
            <button type="button" class="back-button" onclick="showQuestions()">‚Üê Back</button>
            <h2>Domain Suggestions</h2>
            <button id="exportButton" class="secondary-button">Export CSV</button>
        </div>
        <div id="loadingIndicator" hidden>
            <div class="spinner"></div>
            <p>Generating domain suggestions...</p>
        </div>
        <table id="domainsList" class="domains-table">
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Reason</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
// Add input validation
function validateForm() {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = false;  // Always enable the button
}

function showInitialForm() {
    document.getElementById('initial-form').hidden = false;
    document.getElementById('questions').hidden = true;
    document.getElementById('results').hidden = true;
}

function showQuestions() {
    document.getElementById('initial-form').hidden = true;
    document.getElementById('questions').hidden = false;
    document.getElementById('results').hidden = true;
}

document.getElementById('name').addEventListener('input', validateForm);
document.getElementById('description').addEventListener('input', validateForm);

document.getElementById('domainForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const submitButton = document.getElementById('submitButton');
    const name = form.name.value.trim();
    const description = form.description.value.trim();

    if (!name && !description) {
        alert('Please enter either a project name or description');
        return;
    }

    submitButton.classList.add('loading');
    submitButton.disabled = true;

    try {
        const response = await fetch('/api/questions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: description
            })
        });
        const data = await response.json();

        if (data.questions.length > 0) {
            const questionsDiv = document.getElementById('questions');
            const questionsList = document.getElementById('questionsList');
            questionsList.innerHTML = '';

            data.questions.forEach(question => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>${question}</label>
                    <input type="text" name="answer_${question}" required>
                `;
                questionsList.appendChild(div);
            });

            document.getElementById('initial-form').hidden = true;
            document.getElementById('questions').hidden = false;
        } else {
            getDomains(name, description, []);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while processing your request');
    } finally {
        submitButton.classList.remove('loading');
        submitButton.disabled = false;
    }
});

document.getElementById('questionsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.classList.add('loading');
    submitButton.disabled = true;

    try {
        const answers = Array.from(form.elements)
            .filter(el => el.name.startsWith('answer_'))
            .map(el => ({
                question: el.name.replace('answer_', ''),
                answer: el.value
            }));

        const name = document.getElementById('name').value;
        const description = document.getElementById('description').value;
        await getDomains(name, description, answers);
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while processing your request');
    } finally {
        submitButton.classList.remove('loading');
        submitButton.disabled = false;
    }
});

async function getDomains(name, description, answeredQuestions) {
    const resultsDiv = document.getElementById('results');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const domainsList = document.getElementById('domainsList').querySelector('tbody');

    document.getElementById('initial-form').hidden = true;
    document.getElementById('questions').hidden = true;
    resultsDiv.hidden = false;
    loadingIndicator.hidden = false;
    domainsList.innerHTML = '';

    try {
        const response = await fetch('/api/domains', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name,
                description,
                answered_questions: answeredQuestions
            })
        });
        const data = await response.json();

        data.domains.forEach(domain => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${domain.domain}</td>
                <td>${domain.reason}</td>
                <td><span class="trash-icon" onclick="removeDomain(this)">üóëÔ∏è</span></td>
            `;
            domainsList.appendChild(row);
        });
    } catch (error) {
        console.error('Error fetching domains:', error);
    } finally {
        loadingIndicator.hidden = true;
    }
}

function removeDomain(element) {
    element.closest('tr').remove();
}

document.getElementById('exportButton').addEventListener('click', () => {
    const rows = document.querySelectorAll('#domainsList tbody tr');
    const csvContent = [
        ['Domain', 'Reason'],
        ...Array.from(rows).map(row => [
            row.cells[0].textContent,
            `"${row.cells[1].textContent.replace(/"/g, '""')}"`
        ])
    ].map(row => row.join(',')).join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'domain-suggestions.csv';
    link.click();
});
</script>
{% endblock %}
